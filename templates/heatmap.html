{% extends 'base.html' %}

{% block content %}

<style>
	body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .mapboxgl-popup {
        position: absolute; 
        top: 0; 
        bottom: 0; 
        width: 100%;
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        background: #212121;
    }
</style>

    <div id="map"></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoidGhpbmtpbmdyZWVkIiwiYSI6ImNrN2JnODFpMTAzemEzZWxrdjVmMWs1aDgifQ.ilp7OlnOWSrRkVltnP8biQ';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v10',
            maxzoom: 20,
            maxBounds: [['-133.41939491845818', '23.017523213871456'],['-63.82091914427555', '50.85158440021044']]
        });
           
        map.on('load', function() {

        {% if map_zoom %} map.setZoom({{map_zoom}}); {% endif %}
        {% if map_center %}  map.setCenter({{map_center}}), {% endif %}    

        // Add a geojson point source.
        // Heatmap layers also work with a vector tile source.
        map.addSource('gunviolence', {
            'type': 'geojson',
            'data': {{ points|safe }},
            //cluster: true,
        });

        // Add a source for the state polygons.
        map.addSource('states', {
            'type': 'geojson',
            'data': {{ states|safe }}
        });

        map.addLayer(
            {
                'id': 'states-layer',
                'source': 'states',
                'maxzoom': 9,
                'type': 'fill',
                'paint': {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'involve'],
                        {{state_min}},
                        ['to-color', '#eff3ff'],
                        {{state_max}},
                        ['to-color', '#08519c']
                    ],
                    'fill-opacity': [
                        'interpolate',['linear'],['zoom'],0,1,9,0
                    ]
                }
            },
            'waterway-label'
        );
        
        map.addLayer(
            {
                'id': 'gunviolence-point',
                'type': 'circle',
                'source': 'gunviolence',
                'minzoom': 7,
                'paint': {
                    'circle-radius': [
                        'interpolate',['linear'],['zoom'],7,
                        ['interpolate', ['linear'], ['get', 'involve'], 0, 1, 10, 5],24,
                        ['interpolate', ['linear'], ['get', 'involve'], 0, 10, 10, 100]
                    ],
                    'circle-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'involve'],
                        {{case_min}},
                        ['to-color', '#eff3ff'],
                        {{case_max}},
                        ['to-color', '#08519c']
                    ],
                    'circle-stroke-color': 'white',
                    'circle-stroke-width': 1,
                    'circle-opacity': [
                        'interpolate',['linear'],['zoom'],7,0,9,1
                    ]
                }
            },
            'waterway-label'
        );

        map.on('click', 'gunviolence-point', function(e) {
            //var iid = e.features[0].properties.incident_id
            //console.log("click on point " + iid.toString());
            //var redirect_url = "{% url 'single_case' 1234 %}";
            //redirect_url = redirect_url.replace(1234, iid);
            //parent.onClickIncidentPoint(e.features[0].properties.incident_id)
            parent.document.location.href = e.features[0].properties.source_url;
        });

        map.on('click', 'states-layer', function(e) {
            console.log("click on layer");
        });
        
        // Change the cursor to a pointer when the mouse is over the states layer.
        map.on('mouseenter', 'states-layer', function() {
            map.getCanvas().style.cursor = 'pointer';
        });
        
        // Change it back to a pointer when it leaves.
        map.on('mouseleave', 'states-layer', function() {
            map.getCanvas().style.cursor = '';
        });

        map.on('zoomend', function() {
                var features = map.queryRenderedFeatures({layers:['gunviolence-point']});
                console.log(features);
                console.log(map.getZoom());
                $.ajax({
                    type: "GET",
                    url: "{% url 'save_map_meta' %}",
                    dataType: "json",
                    data: {
                        "map_zoom": map.getZoom(),
                        "map_center": map.getCenter().toArray(),
                    },
                    success: function(data){
                        console.log("success");
                        console.log(data);
                    },
                    failure: function(data){
                        console.log("failure");
                        console.log(data);
                    },
                });
            }
        )

        });
    </script>
 
{% endblock %}